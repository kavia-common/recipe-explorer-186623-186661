---
import BaseLayout from '../layouts/BaseLayout.astro';
import RecipeCard from '../components/RecipeCard.astro';
import SearchBar from '../components/SearchBar.astro';
import { fetchRecipes } from '../lib/api';
import type { Recipe } from '../lib/mockData';

const recipes = await fetchRecipes();
---

<BaseLayout title="Recipe Explorer">
  <section aria-labelledby="browse-heading" style="display:grid; gap: 1rem;">
    <h1 id="browse-heading" style="margin:.5rem 0 0;">Browse Recipes</h1>
    <p style="margin:0; color:#4b5563;">Discover delightful meals and sweet treats.</p>

    <div class="search-inline" style="display:grid; gap:.5rem;">
      <SearchBar id="home-search" placeholder="Search by name, tag, or ingredient..." />
    </div>

    <div id="recipe-grid" class="grid grid-cols-responsive" aria-live="polite">
      {recipes.map((r: Recipe) => <RecipeCard recipe={r} />)}
    </div>
  </section>

  <script>
    type Recipe = {
      id: string;
      title: string;
      description: string;
      image?: string;
      tags?: string[];
      rating?: number;
      time?: string;
    };

    const allCards = Array.from(document.querySelectorAll<HTMLAnchorElement>('#recipe-grid > a.recipe-card'));
    const items: { el: HTMLAnchorElement; text: string; tags: string }[] = allCards.map((el) => {
      const title = el.querySelector('.title')?.textContent ?? '';
      const desc = el.querySelector('.desc')?.textContent ?? '';
      const tags = Array.from(el.querySelectorAll('.tag')).map(t => t.textContent || '').join(' ');
      return { el, text: (title + ' ' + desc).toLowerCase(), tags: tags.toLowerCase() };
    });

    function applyFilter(term: string) {
      const q = term.trim().toLowerCase();
      let visibleCount = 0;
      for (const it of items) {
        const show = q.length === 0 || it.text.includes(q) || it.tags.includes(q);
        it.el.style.display = show ? '' : 'none';
        if (show) visibleCount++;
      }
      const grid = document.getElementById('recipe-grid')!;
      grid.setAttribute('data-count', String(visibleCount));
    }

    window.addEventListener('recipes:search', (e: Event) => {
      const detail = (e as CustomEvent).detail;
      applyFilter(detail?.term ?? '');
    });
  </script>
</BaseLayout>
